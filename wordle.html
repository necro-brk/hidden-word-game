<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Hidden Word â€“ PaylaÅŸÄ±mlÄ± Kelime Oyunu</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050813;
      color: #f9fafb;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    #app {
      width: 900px;
      max-width: 100vw;
      padding: 20px;
    }
    h1 {
      margin: 0 0 4px 0;
      text-align: center;
      letter-spacing: 6px;
      font-size: 24px;
    }
    .subtitle {
      text-align: center;
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 18px;
    }
    .panel {
      background: radial-gradient(circle at top, rgba(56,189,248,0.1), transparent 60%),
                  radial-gradient(circle at bottom, rgba(147,51,234,0.15), transparent 60%),
                  #020617;
      border-radius: 16px;
      padding: 16px 18px;
      border: 1px solid #1f2937;
      box-shadow: 0 18px 45px rgba(15,23,42,0.9);
      margin-bottom: 16px;
    }
    label {
      font-size: 14px;
      display: block;
      margin-bottom: 6px;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #f9fafb;
      font-size: 16px;
      letter-spacing: 4px;
      text-transform: uppercase;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.3);
    }
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
    }
    button {
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      box-shadow: 0 8px 18px rgba(22,163,74,0.5);
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.15s ease;
      white-space: nowrap;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(22,163,74,0.7);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(22,163,74,0.4);
    }
    .creator-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
    }
    .creator-row > div { flex: 1 1 220px; }
    #generated-link-wrap {
      margin-top: 10px;
      font-size: 13px;
      color: #e5e7eb;
      display: none;
    }
    #generated-link {
      margin-top: 6px;
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      font-size: 12px;
      border: 1px solid #374151;
      background: #020617;
      color: #9ca3af;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15,118,110,0.2);
      color: #6ee7b7;
    }
    #status {
      min-height: 22px;
      font-size: 14px;
      margin-bottom: 8px;
    }
    #board {
      margin: 10px auto 16px;
      width: 100%;
      max-width: 520px;
      display: grid;
      grid-template-columns: repeat(var(--cols, 5), minmax(0, 1fr));
      grid-gap: 6px;
    }
    .tile {
      width: 100%;
      padding-top: 100%;
      position: relative;
      border-radius: 6px;
      border: 2px solid #1f2937;
      background: #020617;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 22px;
      font-weight: 700;
      color: #e5e7eb;
      text-transform: uppercase;
    }
    .tile-inner {
      position: absolute;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .tile-filled { border-color: #4b5563; }
    .tile-correct {
      background: #16a34a;
      border-color: #16a34a;
      color: #f9fafb;
    }
    .tile-present {
      background: #eab308;
      border-color: #eab308;
      color: #111827;
    }
    .tile-absent {
      background: #111827;
      border-color: #111827;
      color: #6b7280;
    }
    #keyboard {
      max-width: 540px;
      margin: 0 auto;
      user-select: none;
    }
    .kb-row {
      display: flex;
      justify-content: center;
      margin-bottom: 6px;
      gap: 4px;
    }
    .key {
      flex: 1 1 32px;
      padding: 10px 0;
      border-radius: 6px;
      border: none;
      background: #111827;
      color: #e5e7eb;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
    }
    .key.special {
      flex: 1.5 1 46px;
      font-size: 11px;
    }
    .key-correct { background: #16a34a; color:#f9fafb; }
    .key-present { background: #eab308; color:#111827; }
    .key-absent  { background: #020617; color:#6b7280; }
    #helper {
      text-align: center;
      font-size: 11px;
      color: #9ca3af;
    }
    #leaderboard-panel {
      margin-top: 14px;
      border-top: 1px solid #1f2937;
      padding-top: 10px;
    }
    #leaderboard-panel table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    #leaderboard-panel th,
    #leaderboard-panel td {
      padding: 3px 4px;
    }
    #leaderboard-panel th {
      color: #9ca3af;
      font-weight: 600;
      text-align: left;
    }
    #leaderboard-panel td {
      color: #e5e7eb;
      border-top: 1px solid #020617;
    }
    @media (max-width: 600px) {
      #board { max-width: 100%; }
    }
  </style>
</head>
<body>
<div id="app">
  <h1>HIDDEN WORD</h1>
  <div class="subtitle">
    Gizli bir kelime oluÅŸtur, linki arkadaÅŸÄ±na gÃ¶nder; o kelimeyi tahmin etmeye Ã§alÄ±ÅŸsÄ±n.
  </div>

  <!-- Kelime oluÅŸturma -->
  <div id="creator-section" class="panel">
    <div class="creator-row">
      <div>
        <label>Gizli kelime:</label>
        <input id="secret-input" type="text" placeholder="Ã–rn: ARABA" />
      </div>
      <div>
        <label>Oyun modu:</label>
        <select id="mode-select">
          <option value="free">Serbest uzunluk (TDKâ€™daki tÃ¼m kelimeler)</option>
          <option value="five">Wordle modu (5 harfli)</option>
        </select>
      </div>
      <div style="flex:0 0 auto;">
        <button id="create-link-btn">Link OluÅŸtur</button>
      </div>
    </div>

    <div id="generated-link-wrap">
      <div>Bu linki arkadaÅŸÄ±na gÃ¶nder:</div>
      <input id="generated-link" type="text" readonly />
      <button id="copy-link-btn" style="margin-top:6px;">Kopyala</button>
    </div>

    <!-- Tek baÅŸÄ±na oynama bÃ¶lÃ¼mÃ¼ -->
    <hr style="margin:14px 0;border-color:#111827;">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
      <div style="font-size:13px;color:#e5e7eb;">
        <strong>Solo mod:</strong> TDK listesinden rastgele kelime ile kendine karÅŸÄ± oyna.
        <div style="font-size:11px;color:#9ca3af;margin-top:2px;">
          YukarÄ±daki oyun modu seÃ§imi (Serbest / 5 harfli) solo mod iÃ§in de geÃ§erli.
        </div>
      </div>
      <button id="solo-start-btn"
              style="padding:8px 12px;font-size:12px;background:linear-gradient(135deg,#6366f1,#4f46e5);box-shadow:none;">
        Solo oyuna baÅŸla
      </button>
    </div>
  </div>

  <!-- Oyun bÃ¶lÃ¼mÃ¼ -->
  <div id="game-section" class="panel" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:8px;">
      <div style="display:flex;align-items:center;gap:8px;">
        <div class="badge">Tahmin modu</div>
        <div id="mode-label" style="font-size:12px;color:#9ca3af;"></div>
      </div>
      <!-- Yeni oyun butonu -->
      <button id="new-game-btn"
              style="padding:6px 10px;font-size:11px;background:linear-gradient(135deg,#f97316,#ea580c);box-shadow:none;">
        Yeni oyun oluÅŸtur
      </button>
    </div>

    <div id="status"></div>
    <div id="board"></div>
    <div id="keyboard"></div>
    <div id="helper">Klavyeden yazabilirsin Â· ENTER ile gÃ¶nder, BACKSPACE ile sil.</div>

    <!-- Leaderboard -->
    <div id="leaderboard-panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <span style="font-size:13px;color:#e5e7eb;font-weight:600;">Leaderboard (bu link)</span>
        <button id="change-name-btn" style="padding:4px 10px;font-size:11px;background:linear-gradient(135deg,#38bdf8,#0ea5e9);box-shadow:none;">Ä°sim deÄŸiÅŸtir</button>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:32px;">#</th>
            <th>Ä°sim</th>
            <th style="text-align:right;width:70px;">Skor</th>
            <th style="text-align:right;width:70px;">Deneme</th>
          </tr>
        </thead>
        <tbody id="lb-body">
          <tr><td colspan="4" style="padding:4px 4px;color:#6b7280;">Leaderboard yÃ¼kleniyorâ€¦</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- TDK kelime listesi / VALID_WORDS burada -->
<script src="words_tr.js"></script>

<script type="module">
  /*************** Firebase Kurulumu ***************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    serverTimestamp,
    query,
    where,
    orderBy,
    limit,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAcKlwqRKpzjJTTp_WptQNxuKLRcJXqH6Y",
    authDomain: "hidden-word-game.firebaseapp.com",
    projectId: "hidden-word-game",
    storageBucket: "hidden-word-game.firebasestorage.app",
    messagingSenderId: "958945265776",
    appId: "1:958945265776:web:1e57bd1b444912b15fccb5",
    measurementId: "G-2QG1KPS68L"
  };

  let db = null;
  let scoresCollection = null;
  let CURRENT_GAME_ID = null;

  try {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    scoresCollection = collection(db, "scores");
  } catch (e) {
    console.warn("Firebase init baÅŸarÄ±sÄ±z. Leaderboard devre dÄ±ÅŸÄ±:", e);
  }

  /* ===== TÃ¼rkÃ§e bÃ¼yÃ¼k harfe Ã§evirme yardÄ±mcÄ±larÄ± ===== */
  function trUpper(str) {
    // Ã¶nce i / Ä± dÃ¶nÃ¼ÅŸÃ¼mlerini yap, sonra klasik upper
    return str
      .replace(/i/g, "Ä°")
      .replace(/Ä±/g, "I")
      .toUpperCase();
  }

  function trUpperChar(ch) {
    if (!ch) return "";
    if (ch === "i") return "Ä°";
    if (ch === "Ä±") return "I";
    return trUpper(ch).charAt(0);
  }

  /* ===== KÃ¼Ã§Ã¼k yardÄ±mcÄ±lar ===== */
  function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

  const SECRET_SHIFT = 37;
  function encodeSecret(word) {
    const parts = [];
    for (let i = 0; i < word.length; i++) {
      parts.push(word.charCodeAt(i) + SECRET_SHIFT);
    }
    return parts.join("x");
  }
  function decodeSecret(code) {
    if (!code) return "";
    return code
      .split("x")
      .map(p => String.fromCharCode(parseInt(p,10) - SECRET_SHIFT))
      .join("");
  }

  /* ===== KullanÄ±cÄ± adÄ± & Leaderboard ===== */
  const NAME_KEY = "hiddenWordPlayerName_v1";
  let playerName = "";

  function getPlayerName() {
    if (playerName) return playerName;
    const stored = localStorage.getItem(NAME_KEY);
    if (stored) {
      playerName = stored;
      return playerName;
    }
    let name = prompt("KullanÄ±cÄ± adÄ±nÄ± yaz (leaderboard iÃ§in):", "") || "Ä°simsiz";
    name = name.trim() || "Ä°simsiz";
    playerName = name;
    localStorage.setItem(NAME_KEY, name);
    return name;
  }

  function changePlayerName() {
    let name = prompt("Yeni kullanÄ±cÄ± adÄ±n:", playerName || "") || playerName || "Ä°simsiz";
    name = name.trim() || "Ä°simsiz";
    playerName = name;
    localStorage.setItem(NAME_KEY, name);
    alert("Ä°sim gÃ¼ncellendi: " + name);
  }

  function renderLeaderboardFallback(message) {
    const tbody = document.getElementById("lb-body");
    if (!tbody) return;
    tbody.innerHTML = `<tr><td colspan="4" style="padding:4px 4px;color:#f97316;">${message}</td></tr>`;
  }

  function renderLeaderboard(rows) {
    const tbody = document.getElementById("lb-body");
    if (!tbody) return;
    tbody.innerHTML = "";
    if (!rows.length) {
      tbody.innerHTML = '<tr><td colspan="4" style="padding:4px 4px;color:#6b7280;">Bu link iÃ§in henÃ¼z skor yok.</td></tr>';
      return;
    }
    rows.forEach((item, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${item.name || "Ä°simsiz"}</td>
        <td style="text-align:right;">${item.score}</td>
        <td style="text-align:right;">${item.attempts}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function addScoreToLeaderboard(name, score, attempts, word, gameId) {
    if (!scoresCollection) {
      console.warn("Leaderboard devrede deÄŸil, skor kaydedilmedi.");
      return;
    }
    try {
      await addDoc(scoresCollection, {
        name,
        score,
        attempts,
        wordLength: word.length,
        gameId,
        createdAt: serverTimestamp()
      });
    } catch (e) {
      console.error("Skor yazÄ±lÄ±rken hata:", e);
    }
  }

  function subscribeLeaderboard(gameId) {
    if (!scoresCollection) {
      renderLeaderboardFallback("Firebase yapÄ±landÄ±rÄ±lmadÄ±, leaderboard devre dÄ±ÅŸÄ±.");
      return;
    }
    try {
      const q = query(
        scoresCollection,
        where("gameId", "==", gameId),
        limit(100)
      );

      onSnapshot(
        q,
        (snapshot) => {
          const rows = [];
          snapshot.forEach((doc) => rows.push(doc.data()));

          rows.sort((a, b) => {
            if (b.score !== a.score) return b.score - a.score;
            const ta = a.createdAt && a.createdAt.toMillis ? a.createdAt.toMillis() : 0;
            const tb = b.createdAt && b.createdAt.toMillis ? b.createdAt.toMillis() : 0;
            return ta - tb;
          });

          renderLeaderboard(rows);
        },
        (error) => {
          console.error("Leaderboard okunamadÄ±:", error);
          renderLeaderboardFallback("Leaderboard yÃ¼klenirken hata oluÅŸtu.");
        }
      );
    } catch (e) {
      console.error("Leaderboard subscribe hatasÄ±:", e);
      renderLeaderboardFallback("Leaderboard yÃ¼klenirken hata oluÅŸtu.");
    }
  }

  /* ===== App baÅŸlangÄ±cÄ± ===== */
  let creatorSection, gameSection;

  window.addEventListener("load", async () => {
    if (window.WORDS_READY) {
      try { await window.WORDS_READY; } catch (e) {}
    }
    startApp();
  });

  function startApp() {
    creatorSection = document.getElementById("creator-section");
    gameSection   = document.getElementById("game-section");

    const secretInput   = document.getElementById("secret-input");
    const modeSelect    = document.getElementById("mode-select");
    const createBtn     = document.getElementById("create-link-btn");
    const linkWrap      = document.getElementById("generated-link-wrap");
    const linkInput     = document.getElementById("generated-link");
    const copyBtn       = document.getElementById("copy-link-btn");
    const changeNameBtn = document.getElementById("change-name-btn");
    const newGameBtn    = document.getElementById("new-game-btn");
    const soloStartBtn  = document.getElementById("solo-start-btn");

    const codeParam = getQueryParam("code");
    const modeParam = getQueryParam("mode") || "free";

    if (changeNameBtn) {
      changeNameBtn.addEventListener("click", () => {
        changePlayerName();
      });
    }

    /* ===== SOLO MOD ===== */
    if (soloStartBtn) {
      soloStartBtn.addEventListener("click", async () => {
        if (window.WORDS_READY) {
          try {
            await window.WORDS_READY;
          } catch (e) {
            console.error("Kelime listesi yÃ¼klenirken hata:", e);
          }
        }

        let allWords = [];

        if (typeof VALID_WORDS !== "undefined") {
          if (Array.isArray(VALID_WORDS)) {
            allWords = VALID_WORDS.slice();
          } else if (VALID_WORDS instanceof Set || typeof VALID_WORDS.has === "function") {
            allWords = Array.from(VALID_WORDS);
          }
        }

        if (!allWords.length) {
          alert("Kelime listesi yÃ¼klenemedi, lÃ¼tfen sayfayÄ± yenilemeyi dene.");
          return;
        }

        const mode = modeSelect ? modeSelect.value : "free";

        let candidates = allWords;
        if (mode === "five") {
          candidates = candidates.filter(w => w.length === 5);
        }

        if (!candidates.length) {
          alert("Bu mod iÃ§in uygun kelime bulunamadÄ±.");
          return;
        }

        const randomIndex = Math.floor(Math.random() * candidates.length);
        const secretWord  = trUpper(candidates[randomIndex]);

        CURRENT_GAME_ID = `solo-${mode}`;

        const url = new URL(window.location.href);
        url.search = "";
        window.history.pushState({}, "", url.toString());

        if (creatorSection) creatorSection.style.display = "none";
        if (gameSection)    gameSection.style.display    = "block";

        const modeLabel = document.getElementById("mode-label");
        if (modeLabel) {
          modeLabel.textContent = mode === "five"
            ? "Mod: Wordle (5 harfli kelime) â€“ Solo"
            : "Mod: Serbest uzunluk â€“ Solo";
        }

        getPlayerName();
        subscribeLeaderboard(CURRENT_GAME_ID);
        initGame(secretWord, CURRENT_GAME_ID);
      });
    }

    /* ===== Yeni oyun butonu ===== */
    if (newGameBtn) {
      newGameBtn.addEventListener("click", () => {
        const url = new URL(window.location.href);
        url.search = "";
        window.history.pushState({}, "", url.toString());

        if (secretInput) secretInput.value = "";
        if (modeSelect)  modeSelect.value  = "free";

        if (creatorSection) creatorSection.style.display = "block";
        if (gameSection)    gameSection.style.display    = "none";

        const tbody = document.getElementById("lb-body");
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="4" style="padding:4px 4px;color:#6b7280;">Leaderboard yÃ¼kleniyorâ€¦</td></tr>';
        }
      });
    }

    /* ===== Link oluÅŸturma modu ===== */
    if (createBtn) {
      createBtn.addEventListener("click", () => {
        let word = (secretInput.value || "").trim();
        const mode = modeSelect.value;

        if (!word) {
          alert("LÃ¼tfen bir gizli kelime yaz.");
          return;
        }

        word = word.replace(/\s+/g, "");
        word = trUpper(word);

        if (mode === "five" && word.length !== 5) {
          alert("Wordle modunda kelime 5 harfli olmalÄ±.");
          return;
        }

        if (!/^[A-ZÃ‡ÄžÄ°Ã–ÅžÃœI]+$/.test(word)) {
          if (!confirm("Kelimenizde harf dÄ±ÅŸÄ± karakter var. Yine de kullanmak istiyor musun?")) {
            return;
          }
        }

        const code = encodeSecret(word);
        const url  = `${window.location.origin}${window.location.pathname}?code=${code}&mode=${mode}`;
        linkInput.value = url;
        linkWrap.style.display = "block";
      });
    }

    if (copyBtn) {
      copyBtn.addEventListener("click", () => {
        linkInput.select();
        document.execCommand("copy");
        copyBtn.textContent = "KopyalandÄ± âœ”";
        setTimeout(() => copyBtn.textContent = "Kopyala", 1500);
      });
    }

    /* ===== Tahmin modu (arkadaÅŸ linki) ===== */
    if (codeParam) {
      CURRENT_GAME_ID = `${modeParam}:${codeParam}`;

      creatorSection.style.display = "none";
      gameSection.style.display    = "block";

      setTimeout(() => { getPlayerName(); }, 50);
      subscribeLeaderboard(CURRENT_GAME_ID);

      let secretWord = decodeSecret(codeParam);
      secretWord = trUpper(secretWord).replace(/\s+/g, "");

      if (!/^[A-ZÃ‡ÄžÄ°Ã–ÅžÃœI]+$/.test(secretWord) || secretWord.length < 2) {
        secretWord = "HATA";
      }
      if (modeParam === "five" && secretWord.length !== 5) {
        secretWord = secretWord.slice(0,5).padEnd(5, "A");
      }

      const modeLabel = document.getElementById("mode-label");
      modeLabel.textContent = modeParam === "five"
        ? "Mod: Wordle (5 harfli kelime)"
        : "Mod: Serbest uzunluk";

      initGame(secretWord, CURRENT_GAME_ID);
    }
  }

  /* ===== Oyun mantÄ±ÄŸÄ± ===== */
  function initGame(secretWord, gameId) {
    const ROWS = 6;
    const COLS = secretWord.length;

    const boardElem    = document.getElementById("board");
    const statusElem   = document.getElementById("status");
    const keyboardElem = document.getElementById("keyboard");

    boardElem.style.setProperty("--cols", COLS);

    let currentRow = 0;
    let currentCol = 0;
    let finished   = false;

    const tiles = [];
    boardElem.innerHTML = "";
    for (let r = 0; r < ROWS; r++) {
      tiles[r] = [];
      for (let c = 0; c < COLS; c++) {
        const tile  = document.createElement("div");
        tile.className = "tile";
        const inner = document.createElement("div");
        inner.className = "tile-inner";
        tile.appendChild(inner);
        boardElem.appendChild(tile);
        tiles[r][c] = tile;
      }
    }

    function showStatus(msg, color) {
      statusElem.textContent = msg;
      statusElem.style.color = color || "#e5e7eb";
    }

    function getCurrentGuess() {
      let guess = "";
      for (let c = 0; c < COLS; c++) {
        const ch = tiles[currentRow][c].querySelector(".tile-inner").textContent || "";
        guess += ch;
      }
      return guess;
    }

    function setTile(r, c, ch) {
      const tile  = tiles[r][c];
      const inner = tile.querySelector(".tile-inner");
      inner.textContent = ch;
      if (ch) tile.classList.add("tile-filled");
      else    tile.classList.remove("tile-filled");
    }

    // Sanal klavye
    const kbLayout = [
      "QWERTYUIOPÄžÃœ",
      "ASDFGHJKLÅžÄ°",
      "ZXCVBNMÃ–Ã‡"
    ];
    keyboardElem.innerHTML = "";
    const keyButtons = {};
    const keyState   = {};

    kbLayout.forEach((row, idx) => {
      const rowDiv = document.createElement("div");
      rowDiv.className = "kb-row";

      if (idx === 2) {
        const enterBtn = createKey("ENTER", "ENTER", true);
        rowDiv.appendChild(enterBtn);
      }

      for (const ch of row) {
        const btn = createKey(ch, ch);
        rowDiv.appendChild(btn);
        keyButtons[ch] = btn;
      }

      if (idx === 2) {
        const backBtn = createKey("âŒ«", "BACK", true);
        rowDiv.appendChild(backBtn);
      }

      keyboardElem.appendChild(rowDiv);
    });

    function createKey(label, value, special=false) {
      const btn = document.createElement("button");
      btn.className = "key" + (special ? " special" : "");
      btn.textContent = label;
      btn.dataset.value = value;
      btn.addEventListener("click", () => handleKey(value));
      return btn;
    }

    window.addEventListener("keydown", onKeyDown);

    function onKeyDown(e) {
      if (finished) return;
      const key = e.key;
      if (key === "Enter") handleKey("ENTER");
      else if (key === "Backspace") handleKey("BACK");
      else {
        const ch = trUpperChar(key);
        if (/^[A-ZÃ‡ÄžÄ°Ã–ÅžÃœI]$/.test(ch)) handleKey(ch);
      }
    }

    function handleKey(key) {
      if (finished) return;

      if (key === "ENTER") {
        submitGuess();
        return;
      }
      if (key === "BACK") {
        if (currentCol > 0) {
          currentCol--;
          setTile(currentRow, currentCol, "");
        }
        return;
      }

      if (currentCol >= COLS) return;
      setTile(currentRow, currentCol, key);
      currentCol++;
    }

    function submitGuess() {
      if (finished) return;

      const guess = getCurrentGuess();
      if (guess.length < COLS) {
        showStatus(`Kelime eksik. Bu kelime ${COLS} harfli.`, "#f97316");
        return;
      }

      const upperGuess = trUpper(guess);

      // SÃ¶zlÃ¼k kontrolÃ¼ (VALID_WORDS bÃ¼yÃ¼k harfle tutuluyorsa)
      if (upperGuess !== secretWord &&
          typeof VALID_WORDS !== "undefined" &&
          VALID_WORDS &&
          typeof VALID_WORDS.has === "function" &&
          !VALID_WORDS.has(upperGuess)) {
        showStatus("Bu kelime sÃ¶zlÃ¼kte yok gibi gÃ¶rÃ¼nÃ¼yor.", "#f97316");
        return;
      }

      const result = evaluateGuess(upperGuess, secretWord);
      colorRow(currentRow, upperGuess, result);

      if (upperGuess === secretWord) {
        const attempts = currentRow + 1;
        const base = 1200;
        const score = Math.max(
          10,
          base - (attempts - 1) * 150 - (secretWord.length - 3) * 20
        );
        const name = getPlayerName();
        addScoreToLeaderboard(name, score, attempts, secretWord, gameId);
        showStatus(`Tebrikler, kelimeyi buldun! ðŸŽ‰ Skorun: ${score}`, "#22c55e");
        finished = true;
        return;
      }

      if (currentRow === ROWS - 1) {
        showStatus(`Bitti! Gizli kelime: ${secretWord}`, "#f97316");
        finished = true;
        return;
      }

      currentRow++;
      currentCol = 0;
      showStatus("Yeni bir tahmin yap!");
    }

    function evaluateGuess(guess, secret) {
      const COLS = secret.length;
      const res       = Array(COLS).fill("absent");
      const secretArr = secret.split("");
      const used      = new Array(COLS).fill(false);

      for (let i = 0; i < COLS; i++) {
        if (guess[i] === secret[i]) {
          res[i] = "correct";
          used[i] = true;
        }
      }
      for (let i = 0; i < COLS; i++) {
        if (res[i] === "correct") continue;
        const ch = guess[i];
        let found = false;
        for (let j = 0; j < COLS; j++) {
          if (!used[j] && secretArr[j] === ch) {
            used[j] = true;
            found = true;
            break;
          }
        }
        if (found) res[i] = "present";
      }
      return res;
    }

    function colorRow(rowIndex, guess, result) {
      const COLS = guess.length;
      for (let c = 0; c < COLS; c++) {
        const tile = tiles[rowIndex][c];
        tile.classList.remove("tile-filled","tile-correct","tile-present","tile-absent");

        const state = result[c];
        tile.classList.add("tile-" + state);

        const ch   = guess[c];
        const prev = keyState[ch];
        if (!prev || prev === "absent" || (prev === "present" && state === "correct")) {
          keyState[ch] = state;
          const btn = keyButtons[ch];
          if (btn) {
            btn.classList.remove("key-correct","key-present","key-absent");
            if (state === "correct") btn.classList.add("key-correct");
            else if (state === "present") btn.classList.add("key-present");
            else btn.classList.add("key-absent");
          }
        }
      }
    }

    showStatus("Kelimeyi tahmin etmeye baÅŸla!");
  }
</script>
</body>
</html>

